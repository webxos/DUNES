#!/bin/bash

# --- CUSTOMIZATION POINT: Configure environment variables ---
# Replace with your specific paths, versions, and credentials (e.g., NVIDIA driver path, CUDA version)
export NVIDIA_DRIVER_PATH="/usr/local/nvidia"  # Path to NVIDIA driver installation
export CUDA_VERSION="11.8"  # Specify your CUDA version
export TENSORRT_VERSION="8.5"  # Specify your TensorRT version
export AEGIS_HOME="/opt/aegis"  # --- CUSTOMIZATION POINT: Specify your Aegis installation directory ---

# --- CUSTOMIZATION POINT: Define prerequisites installation logic ---
# Adjust package list or installation commands based on your OS (e.g., Ubuntu, CentOS)
install_prerequisites() {
    sudo apt-get update
    sudo apt-get install -y ffmpeg libavcodec-dev libavformat-dev libsrt-dev
    echo "Installed prerequisites"
}

# --- CUSTOMIZATION POINT: Define build and deployment logic ---
# Adjust CMake flags, build targets, or deployment commands (e.g., Docker, Kubernetes)
build_aegis() {
    mkdir -p $AEGIS_HOME/build
    cd $AEGIS_HOME/build
    cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_WITH_PYTHON=ON \
             -DCUDA_TOOLKIT_ROOT_DIR=$NVIDIA_DRIVER_PATH/cuda-$CUDA_VERSION \
             -DTENSORRT_DIR=$NVIDIA_DRIVER_PATH/tensorrt-$TENSORRT_VERSION
    make -j$(nproc)
    sudo make install
    echo "Built and installed Aegis"
}

# --- CUSTOMIZATION POINT: Define service startup logic ---
# Adjust service name, config path, and port (e.g., 'aegis.service', '/etc/aegis/config.yaml')
start_service() {
    sudo systemctl start aegis  # --- CUSTOMIZATION POINT: Replace with your service name ---
    sudo systemctl enable aegis
    echo "Started Aegis service"
}

# Main execution
install_prerequisites
build_aegis
start_service