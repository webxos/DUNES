<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vial MCP Diagram Editor</title>
    <style>
        body { margin: 0; background: #000000; color: #00ff00; font-family: monospace; }
        #canvas { width: 100vw; height: 80vh; }
        #console { width: 100vw; height: 20vh; background: #111111; border-top: 2px solid #00ff00; }
        #console-input { width: 100%; background: #111111; color: #00ff00; border: none; }
        .button { background: #00ff00; color: #000000; padding: 5px; margin: 5px; cursor: pointer; }
        svg rect, svg line { stroke: #00ff00; fill: none; }
        svg text { fill: #00ff00; font-size: 12px; }
        .draggable { cursor: move; }
    </style>
</head>
<body>
    <div>
        <button class="button" onclick="addBox('API Server')">Add API Server</button>
        <button class="button" onclick="addBox('Agent')">Add Agent</button>
        <button class="button" onclick="addBox('Endpoint')">Add Endpoint</button>
        <button class="button" onclick="startLine()">Draw Line</button>
        <button class="button" onclick="exportDiagram()">Export Diagram</button>
        <button class="button" onclick="deployDiagram()">Deploy to GitHub Pages</button>
        <button class="button" onclick="showHelp()">Help</button>
    </div>
    <svg id="canvas"></svg>
    <div id="console">
        <input id="console-input" type="text" placeholder="/help for commands">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        const svg = document.getElementById('canvas');
        let elements = [];
        let currentLine = null;
        let selectedElement = null;

        function addBox(type) {
            if (!validateDiagram(type)) {
                alert('Invalid diagram structure: Ensure input/output flow.');
                return;
            }
            const id = `box-${elements.length}`;
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', 50); rect.setAttribute('y', 50);
            rect.setAttribute('width', 100); rect.setAttribute('height', 50);
            rect.setAttribute('class', 'draggable');
            rect.dataset.id = id;
            rect.dataset.type = type;
            svg.appendChild(rect);
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', 60); text.setAttribute('y', 75);
            text.textContent = type;
            svg.appendChild(text);
            elements.push({ id, type, rect, text });
            makeDraggable(rect);
        }

        function startLine() {
            if (currentLine) return;
            currentLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            currentLine.setAttribute('x1', 0); currentLine.setAttribute('y1', 0);
            currentLine.setAttribute('x2', 0); currentLine.setAttribute('y2', 0);
            svg.appendChild(currentLine);
            svg.addEventListener('click', handleLineClick);
        }

        function handleLineClick(event) {
            if (!currentLine) return;
            const rect = svg.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            if (!currentLine.getAttribute('x1')) {
                currentLine.setAttribute('x1', x);
                currentLine.setAttribute('y1', y);
            } else {
                currentLine.setAttribute('x2', x);
                currentLine.setAttribute('y2', y);
                elements.push({ type: 'line', line: currentLine });
                currentLine = null;
                svg.removeEventListener('click', handleLineClick);
            }
        }

        function makeDraggable(element) {
            let isDragging = false;
            let currentX, currentY;
            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                currentX = e.clientX; currentY = e.clientY;
                selectedElement = element;
            });
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = svg.getBoundingClientRect();
                const dx = e.clientX - currentX;
                const dy = e.clientY - currentY;
                const x = parseFloat(element.getAttribute('x')) + dx;
                const y = parseFloat(element.getAttribute('y')) + dy;
                element.setAttribute('x', x);
                element.setAttribute('y', y);
                const text = elements.find(el => el.rect === element)?.text;
                if (text) {
                    text.setAttribute('x', x + 10);
                    text.setAttribute('y', y + 25);
                }
                currentX = e.clientX; currentY = e.clientY;
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                selectedElement = null;
            });
        }

        function validateDiagram(type) {
            if (type === 'API Server' && elements.some(el => el.type === 'API Server')) {
                return false; // Only one API server allowed
            }
            if (elements.length === 0 && type !== 'Input') {
                return false; // Must start with Input
            }
            return true;
        }

        async function exportDiagram() {
            const svgContent = svg.outerHTML;
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function deployDiagram() {
            try {
                const walletAddress = sessionStorage.getItem('wallet_address') || 'e8aa2491-f9a4-4541-ab68-fe7a32fb8f1d';
                const response = await fetch('/wallet/export/' + walletAddress, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('access_token')}` }
                });
                if (!response.ok) throw new Error('Wallet validation failed');
                const svgContent = svg.outerHTML;
                console.log('Deploying diagram to GitHub Pages for wallet:', walletAddress);
                alert('Diagram deployed! Fork the repo at vial.github.io to integrate with WebXOS wallet.');
            } catch (error) {
                console.error('Deployment error:', error);
                alert('Deployment failed: ' + error.message);
            }
        }

        function showHelp() {
            const commands = [
                '/add <type> - Add box (Input, Output, API Server, Agent, Endpoint)',
                '/line - Start drawing a line',
                '/export - Export diagram as SVG',
                '/deploy - Deploy diagram to GitHub Pages',
                '/help - Show this menu'
            ];
            alert(commands.join('\n'));
        }

        document.getElementById('console-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const command = e.target.value.trim();
                e.target.value = '';
                if (command === '/help') showHelp();
                else if (command.startsWith('/add ')) addBox(command.split(' ')[1]);
                else if (command === '/line') startLine();
                else if (command === '/export') exportDiagram();
                else if (command === '/deploy') deployDiagram();
                else alert('Unknown command. Type /help for commands.');
            }
        });
    </script>
</body>
</html>
