<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vial MCP Controller</title>
    <script src="cdn/three.min.js"></script>
    <script src="cdn/orbitcontrols.min.js"></script>
    <script src="cdn/react.min.js"></script>
    <script src="cdn/react-dom.min.js"></script>
    <script src="cdn/tailwind.min.js"></script>
    <script src="cdn/langchain.min.js"></script>
</head>
<body>
    <div id="root" class="min-h-screen bg-gray-100"></div>
    <script type="module">
        import * as THREE from '/cdn/three.min.js';
        import { OrbitControls } from '/cdn/orbitcontrols.min.js';
        import React, { useState, useEffect } from '/cdn/react.min.js';
        import ReactDOM from '/cdn/react-dom.min.js';
        import initThreeJS from '/js/threejs_integrations.js';
        import { configureStore } from 'https://cdn.jsdelivr.net/npm/@reduxjs/toolkit@1.9.5/dist/index.min.js';
        import { Provider, useDispatch, useSelector } from '/cdn/react-redux.min.js';
        import { persistStore, persistReducer } from 'https://cdn.jsdelivr.net/npm/redux-persist@6.0.0/dist/index.min.js';
        import storage from 'https://cdn.jsdelivr.net/npm/redux-persist@6.0.0/lib/storage/index.min.js';

        const authSlice = {
            name: 'auth',
            initialState: { token: null },
            reducers: {
                setToken: (state, action) => { state.token = action.payload; },
                clearToken: (state) => { state.token = null; }
            }
        };

        const persistConfig = { key: 'auth', storage };
        const persistedReducer = persistReducer(persistConfig, authSlice);
        const store = configureStore({ reducer: { auth: persistedReducer } });
        const persistor = persistStore(store);

        const tokenMiddleware = (store) => (next) => (action) => {
            if (action.type === 'auth/setToken') {
                localStorage.setItem('token', action.payload);
            } else if (action.type === 'auth/clearToken') {
                localStorage.removeItem('token');
            }
            return next(action);
        };

        store.middleware = [tokenMiddleware];

        const App = () => {
            const dispatch = useDispatch();
            const token = useSelector((state) => state.auth.token);
            const [svgData, setSvgData] = useState([]);

            useEffect(() => {
                const { scene, camera, renderer } = initThreeJS('root');
                const handleSvgSubmit = async (data) => {
                    const response = await fetch('/visual/diagram/save', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(data)
                    });
                    setSvgData(await response.json());
                };
                // Simulate SVG diagram creation
                handleSvgSubmit({ components: [], connections: [] });
            }, [token]);

            return React.createElement('div', { className: 'p-4' },
                React.createElement('h1', { className: 'text-2xl font-bold' }, 'Vial MCP Controller'),
                React.createElement('div', { id: 'three-canvas', className: 'w-full h-96' })
            );
        };

        ReactDOM.render(
            React.createElement(Provider, { store },
                React.createElement(App)
            ),
            document.getElementById('root')
        );
    </script>
</body>
</html>
